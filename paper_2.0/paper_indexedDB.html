<!DOCTYPE html>
<html lang="en">

<head>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>papers</title>
    <link rel="shortcut icon" href="./imgs/paper.ico" type="image/x-icon" />
    
    <script type="text/javascript">
        window.onbeforeunload = function (e) {
            e = e || window.event;
            // 兼容IE8和Firefox 4之前的版本
            if (e) {
                e.returnValue = 'close alterion1';
            }
            db.close(); 
            console.log("DB closed --> leaving...")
            // Chrome, Safari, Firefox 4+, Opera 12+ , IE 9+
            return 'close alterion2';

        }
    </script>


	<!--link rel="stylesheet" href="./bootstrap/bootstrap-4.5.0-dist/css/bootstrap.min.css"-->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">

    <link rel="stylesheet" href="./fontawesome-free-5.14.0-web/css/all.css">
    <!--link rel="stylesheet" href="./bootstrap-table-develop/dist/bootstrap-table.min.css"-->
    <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.15.3/dist/bootstrap-table.min.css">
    <link rel="stylesheet" href="./css/main.css">

    <!--script src="./jquery/jquery-3.3.1.min.js"></script-->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <!--script src="./popper-core-2.4.4/dist/umd/popper.js"></script-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <!--script src="./bootstrap/bootstrap-4.5.0-dist/js/bootstrap.min.js"></script-->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
    <!--script src="./bootstrap-table-develop/dist/bootstrap-table.min.js"></script-->
    <script src="https://unpkg.com/bootstrap-table@1.15.3/dist/bootstrap-table.min.js"></script>


    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="./bootstrap-select-1.13.14/dist/css/bootstrap-select.min.css">
    <!-- Latest compiled and minified JavaScript -->
    <script src="./bootstrap-select-1.13.14/dist/js/bootstrap-select.min.js"></script>

    <!-- (Optional) Latest compiled and minified JavaScript translation files -->
    <!--<script src="./bootstrap-select-1.13.14/dist/js/i18n/defaults-*.min.js"></script>-->

    <link rel="stylesheet" href="./Image-Select-2.0/src/chosen/chosen.css">
    <link rel="stylesheet" href="./Image-Select-2.0/src/ImageSelect.css">

    <script type="text/javascript" src="./tableExport/libs/FileSaver/FileSaver.min.js"></script>
    <script type="text/javascript" src="./tableExport/tableExport.min.js"></script>

    <!-- to convert markdown to html -->
    <script type="text/javascript" src="./showdown-1.9.1/dist/showdown.js"></script>



    <!-- 图标工具 -->
    <!--<link rel="stylesheet" type="text/css" href="./incubator-echarts-master/dist/echarts.min.js">-->
    <!--<script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.0.0-alpha.1/echarts.common.js"></script>-->
    <!-- 引入词云 -->
    <!--<script type="text/javascript" src="./echarts-wordcloud-master/dist/echarts-wordcloud.min.js"></script>-->

    <script src="./echarts/dist/code/echarts.js"></script>
    <!-- 引入词云 -->
    <script type="text/javascript" src="./echarts/dist/code/echarts-wordcloud.min.js"></script>

    <!-- Include Dexie -->
    <!--script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script-->

    <!-- 标签 CSS -->
    <style type="text/css">
    	.self_span_bak{
    		background-color: rgb(163,139,75);
			display: inline-block;
			float: left;
			height: 28px;
			line-height: 28px;
			font-size: 10;
            color: white;
			width: 32px;
			border-radius: 4px;
			margin: 2px 5px;
			padding: 0;
			text-align: center;
		}
        .charts_wrapper{
            padding: 10px 20px 10px 10px;
            height: 660px;
            width: 1420px;
            overflow: scroll;
            overflow-x: hidden;
            text-align: center;
        }
        .charts_base{
            border: 2px solid #eee;
            border-radius: 4px;
            box-shadow: 0px 0px 10px 5px rgba(0,0,0,0.9);
            position: fixed;
            height: 660px;
            width: 1400px;
            top: 6px;
            left: calc(50% - 700px);
            margin: 0;
            padding: 0;
            background-color: rgb(250, 249, 222);
        }
        .charts_show{
            z-index: 100;
            opacity: 1;
            overflow: hidden;
        }
        .charts_hide{
            opacity: 0;
            z-index: -100;
            overflow: hidden;
        }
        .panel_show{
            opacity: 1;
            z-index: 50;
        }
        .panel_hide{
            opacity: 0;
            z-index: -100;
        }
        /*@media (max-height:400px) {

        }*/

        #filemenu_btn{
            display: inline-block;
            cursor: pointer;
            position: relative;
        }
        .FileMenu_1, #docs_items{
            background-color: rgb(206,206,206);
            z-index: 100;
            /*display: none;*/
            width: 80px;
        }

        .FileMenu_1{
            display: none;
            position: absolute;
            top: 36px;
            left: 0;
        }
        .FileMenu_2{
            position: relative;
            height: 40px;
            line-height: 40px;
        }
        #docs_items{
            display: none;
            position: absolute;
            top: -10px;
            left: 100%;
        }
        .docs-item{
            height: 40px;
            line-height: 40px;
            color: white;
            text-align: center;
            text-decoration: none;
        }

        .FileMenu_2:hover,.docs-item:hover{
            background-color: white;
            color: red;
        }

        #filemenu_btn:hover>div{
            display: block;
        }

        #label_hover:hover>div{
            display: block;
        }

    </style>


    <!-- 控制面板 --->
    <script>
        window.onload = function(){
            var panel = document.getElementById('panel');
            //判断鼠标是否按下
            var p = false;
            //鼠标按下处在页面中的水平偏移
            var dx = 0;
            //鼠标按下处在页面中的垂直偏移
            var dy = 0;
            //div在页面中的水平偏移
            var sx = 0;
            //div在页面中的垂直偏移
            var sy = 0;

            //鼠标按下时
            panel.onmousedown = function(event){
            	if (document.activeElement.id!='bg' && document.activeElement.id!='search_area') {
	                if (!p) {
	                    p = true;
	                }
	                //处理兼容性和滚动条
	                var event = event || window.event;
	                var scrollLeft = document.documentElement.scrollLeft;
	                var scrollTop = document.documentElement.scrollTop;
	                var pageX = event.pageX || event.clientX + scrollLeft;
	                var pageY = event.pageY || event.clientY + scrollTop;
	                dx = pageX;
	                dy = pageY;
	                sx = panel.offsetLeft;
	                sy = panel.offsetTop;
	            }
            }

            body_select = false;

            var pos_bar = document.getElementById("posbar");
            var pp = false;
            //鼠标按下处在页面中的水平偏移
            var pdx = 0;
            //鼠标按下处在页面中的垂直偏移
            var pdy = 0;

            posbar.onmousedown = function(event){
                if (!pp) {
                    pp = true;
                }
                document.getElementsByTagName("body")[0].setAttribute("unselectable","on");
                document.getElementsByTagName("body")[0].setAttribute("onselectstart","return false");
                //document.getElementsByTagName("body")[0].style.setProperty('-moz-user-select', 'none');
                //处理兼容性和滚动条
                var event = event || window.event;
                /*var scrollLeft = document.documentElement.scrollLeft;
                var scrollTop = document.documentElement.scrollTop;
                var pageX = event.pageX || event.clientX + scrollLeft;
                var pageY = event.pageY || event.clientY + scrollTop;*/
                pdx = event.offsetX;
                pdy = event.offsetY;
                if (pdy < 0) {
                    pdy = 0;
                }
                if (pdy > 300) {
                    pdy = 300;
                }
                document.getElementById("pos_bar_ind").style.height = pdy + 'px';
                paper_scroll_ind = parseInt(Paper_Num * pdy / 300);
                $('#table').bootstrapTable('scrollTo',{unit: 'rows', value: paper_scroll_ind});
                document.getElementById("uproll_input").value = paper_scroll_ind;
            }

            //鼠标移动时
            document.onmousemove = function(event){
                if (p) {
                    var event = event || window.event;
                    var scrollLeft = document.documentElement.scrollLeft;
                    var scrollTop = document.documentElement.scrollTop;
                    var pageX = event.pageX || event.clientX + scrollLeft;
                    var pageY = event.pageY || event.clientY + scrollTop;
                    panel.style.left = pageX - (dx - sx) + 'px';
                    panel.style.top = pageY - (dy - sy) + 'px';
                }
                
            }

            pos_bar.onmousemove = function(event) {
                if (pp) {
                    var event = event || window.event;
                    /*var scrollLeft = document.documentElement.scrollLeft;
                    var scrollTop = document.documentElement.scrollTop;
                    var pageX = event.pageX || event.clientX + scrollLeft;
                    var pageY = event.pageY || event.clientY + scrollTop;*/
                    pdx = event.offsetX;
                    pdy = event.offsetY;
                    if (pdy < 0) {
                        pdy = 0;
                        event.offsetY = 0;
                    }
                    if (pdy > 300) {
                        pdy = 300;
                        event.offsetY = 300;
                    }
                    if (pdx<0 || pdx>16) {
                        pp = false;
                    }
                    //console.log(pdx);
                    //console.log(pdy);
                    document.getElementById("pos_bar_ind").style.height = pdy + 'px';
                    paper_scroll_ind = parseInt(Paper_Num * pdy / 300);
                    $('#table').bootstrapTable('scrollTo',{unit: 'rows', value: paper_scroll_ind});
                    document.getElementById("uproll_input").value = paper_scroll_ind;
                }
            }

            //鼠标松开时
            document.onmouseup = function(){
                if (p) {
                    p = false;
                }
                if (pp) {
                    pp = false;
                }

                document.getElementsByTagName("body")[0].removeAttribute("unselectable","on");
                document.getElementsByTagName("body")[0].removeAttribute("onselectstart","return false");
                //document.getElementsByTagName("body")[0].style.-moz-user-select = null;
            }

        }
    </script>
</head>
 

<body>

    <!-- 控制面板 -->
    <div id="panel" class="panel_hide">
        <div class="panel_head" style="margin-bottom: 10px">
            <div onclick="close_panel()" style="float: right;margin-right: 5px;cursor: pointer;">
                <i class="fas fa-times"></i>
            </div>
            <div>setting</div>
        </div>
        <div class="set_main">
            <div class="form-row" style="height: 40px">
                <div class="form-group col-md-8" style="height: 40px">
                    <input type="text" class="form-control" id="bg" style="height: 40px" placeholder="250 249 222">
                </div>
                <div class="form-group col-md-2" style="height: 40px">
                    <div style="font-size: 30px; color: rgb(250, 249, 222); cursor:pointer;" onclick="set_color()"><i class="fas fa-square"></i></div>
                </div>
            </div>
            <div class="form-row" style="height: 40px; margin-top:10px">
                <div class="form-group col-md-8" style="height: 40px">
                    <input type="text" class="form-control" id="search_area" style="height: 40px" placeholder="author>cg Z">
                </div>
                <div class="form-group col-md-2" style="height: 40px">
                    <div style="font-size: 30px; cursor:pointer;" onclick="search_txt()"><i class="fas fa-search"></i></div>
                </div>
            </div>
            <div class="form-row" style="margin-top:10px;">
                <div class="form-group col-md-3" onclick="import_papers_json()" style="height:40px; font-size:20px; text-align:center; cursor:pointer;">
                    <dv><i class="fas fa-upload"></i></dv>
                    <div style="font-size:12px;">Import</div>
                </div>
                <div class="form-group col-md-3" onclick="To_DB()" style="height:40px; font-size:20px; text-align:center; cursor:pointer;">
                    <div><i class="fas fa-database"></i></div>
                    <div style="font-size:12px;">ToDB</div>
                </div>
                <div class="form-group col-md-3" style="height:40px; font-size:20px; text-align:center">
                    <div><i class="fas fa-upload"></i></div>
                    <div style="font-size:12px;">Append</div>
                </div>
            </div>
            
        </div>
    </div>

    <div id="posbar" style="position:fixed; top:calc((100% - 200px) / 2); left:calc(98% - 16px); z-index:50; background-color:rgb(229,232,235); width:16px; height:300px; margin:auto; cursor:pointer;">
        <div id="pos_bar_ind" style="background-color:rgb(40,167,69); height:0px;"></div>
    </div>


    <div id="uproll" style="position:fixed; top:90%; left:calc(98% - 20px); width:20px; font-size:20px; text-align:center; z-index:100;">
        <div id="uproll_logo" onclick="up2roll()"><i class="fas fa-angle-double-up"></i></div>
        <div id="uproll_input_div"><input id="uproll_input" type="text" style="width:20px;height:20px;font-size:12px;"></div>
    </div>

    <div id="toolbox">
    	<div class="FileMenu" style="display: inline-block;">
    		<div id="filemenu_btn" class="btn btn-dark">Docs<i class="fas fa-caret-down"></i>
                <div class="FileMenu_1">
                    <div class="FileMenu_2">NEW</div>
                    <div class="FileMenu_2">OPEN</div>
                    <div class="FileMenu_2" id="label_hover">Labels
                        <div id="docs_items">
                            
                        </div>
                    </div>
                </div>
            </div>
		</div>
        <button class="btn btn-dark" onclick="set_panel()"><i class="fas fa-cog"></i> Set</button>
		<button class="btn btn-dark" onclick="show_charts()"><i class="far fa-chart-bar"></i> Bar</button>
        <button class="btn btn-dark" data-toggle="modal" data-target="#PaperModal"><i class="far fa-plus-square"></i> Add</button>
        <button class="btn btn-dark" id="edit_table_btn" onclick="delete_rows()"><i class="far fa-trash-alt"></i> Del</button>
        <button class="btn btn-dark" onclick="save_data()"><i class="far fa-save"></i> Save</button>
        <button type="button" id="msg" class="btn btn-outline-dark" style="width:400px;text-align:left;color:red;font-weight:bold;">msg:</button>
    </div>


    <!-- Modal -->
    <!-- 统计模态框 -->
    <div id="charts_modal" class="charts_base charts_hide">
        <div class="charts_wrapper">
            <div class="charts_head" style="margin-bottom: 10px">
                <div onclick="close_chartsmodal()" style="float: right;margin-right: 5px;cursor: pointer;">
                    <i class="fas fa-times"></i>
                </div>
                <div>charts for papers</div>
            </div>

            <div class="charts-container">
                <div class='chart_items' id='chart1' style="width:1200px;height:400px;"></div>
                <div class='chart_items' id='chart2' style="width:400px;height:400px;"></div>
                <div class='chart_items' id='chart3' style="width:400px;height:400px;"></div>
                <div class='chart_items' id='chart4' style="width:400px;height:400px;"></div> 
            </div>
            <div class="charts_footer">
                <button type="button" class="btn btn-info btn-sm" onclick="save_chartsmodal()" style="float: right;margin: 10px;">Save</button>
                <button type="button" class="btn btn-dark btn-sm" onclick="close_chartsmodal()" style="float: right;margin: 10px;">Close</button>
            </div>
        </div>
    </div>


	<!-- Modal -->
	<!-- 笔记模态框 -->
	<div class="modal fade" id="notemodal" data-backdrop="static" data-keyboard="false" tabindex="-1" role="dialog" aria-labelledby="notemodalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
    	    <div class="modal-content">
    	    	<div class="modal-header">
    	    		<h5 class="modal-title" id="notemodalLabel">Paper notes</h5>
    	    	</div>
    	    	<div class="modal-body">
    	    		<div class="form-group">
    	    			<textarea class="form-control" id="notearea" rows="16"></textarea>
    	    		</div>
    	    	</div>
    	    	<div class="modal-footer">
                    <button type="button" class="btn btn-dark btn-sm" onclick="close_notemodal()">Close</button>
                    <button type="button" class="btn btn-info btn-sm" onclick="update_notes()">Save</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal -->
    <div class="modal fade" id="PaperModal" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="PaperModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="PaperModalH">Bib Tex</h5>
          </div>
          <div class="modal-body">
            <form id="BibTex">
                <div class="form-row">
                    <div class="form-group col-md-2">
                        <label for="cite">BibTex</label>
                    </div>
                    <div class="form-group col-md-2">
                        <div style="position: relative; background-color: rgb(52,58,64); height:40px; line-height:40px; text-align:center; color:white; width:60px; border-radius:4px; margin:auto">
                            <label for="cite" style="position:absolute; height:40px; width:60px; top:0; margin:0; padding:0; top:calc(50% - 20px); left:calc(50% - 30px); z-index:1020; cursor:pointer;">cite</label>
                            <input type="file" id="cite" onchange="read_cite()" style="width:50px; height: 35px; opacity: 0;">
                        </div>
                    </div>
                    <div class="form-group col-md-2">
                        <div style="position: relative; background-color: rgb(52,58,64); height:40px; line-height:40px; text-align:center; color:white; width:60px; border-radius:4px; margin:auto">
                            <label for="file" style="position:absolute; height:40px; width:60px; top:0; margin:0; padding:0; top:calc(50% - 20px); left:calc(50% - 30px); z-index:1020; cursor:pointer;">file</label>
                            <input type="file" id="file" onchange="read_file()" style="width:50px; height: 35px; opacity: 0;">
                        </div>
                    </div>
                    <div class="form-group col-md-4">
                        <textarea class="form-control" id="rpath" rows="1">../pdf/</textarea>
                    </div>
                    
                </div>
                <div class="form-group">
                    <textarea class="form-control" id="BibTextext" rows="5"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-2">
                        <label for="rank">Rank</label>
                        <select class="custom-select" id="rank">
                            <option selected>0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                    
                    <div class="form-group col-md-2">
                        <label for="cited">Cited</label>
                        <input type="text" class="form-control" id="cited">
                    </div>

                    <div class="form-group col-md-3">
                        <label for="tags">Tags</label>
                        <input type="text" class="form-control" id="tags">
                    </div>

                </div>
                <div class="form-group">
                    <label for="flags">Flags</label>
                    <select  multiple="multiple" class="my-select" id="flags">
                        <option data-img-src="./Image-Select-2.0/img/new.png">new</option>
                        <option data-img-src="./Image-Select-2.0/img/fire1.png">fire1</option>
                        <option data-img-src="./Image-Select-2.0/img/fire2.png">fire2</option>
                        <option data-img-src="./Image-Select-2.0/img/fire3.png">fire3</option>
                        <option data-img-src="./Image-Select-2.0/img/read.png">read</option>
                        <option data-img-src="./Image-Select-2.0/img/unread.png">unread</option>
                        <option data-img-src="./Image-Select-2.0/img/Notes.png">Notes</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-dark btn-sm" onclick="close_modal()">Close</button>
            <button type="button" class="btn btn-info btn-sm" onclick="add_items()">Save</button>
          </div>
        </div>
      </div>
    </div>

    <div id="table_container" style="height:100%; width:90%; margin:0 auto;overflow-x:hidden">
        <table id="table" class="table"></table>
    </div>

    <script src="./Image-Select-2.0/src/chosen/chosen.jquery.js" type="text/javascript"></script>
    <script src="./Image-Select-2.0/src/ImageSelect.jquery.js" type="text/javascript"></script>

    <script type="text/javascript">
        $(".my-select").chosen({width:"100%"});
    </script>

    <script type="text/javascript">
    	//导入的数据
    	var import_json = new Array();
        //to store label for span
        var edit_notes = ""; //存储编辑框中的笔记
        var edit_time = ""; //编辑的时间，获取时间时，不应该改变
        var add_pos = 0; //全局变量
        var add_flag = "insert";
        var note_ind = null;
        var note_id = null;

        var g_span_labels = new Array();
        var color_min = 0;
        var color_max = 255;
        var se = document.getElementById("flags");
        var f = se.getElementsByTagName("option");
        var Paper_Num = 0;
        var cite_file_type = null;

        function loadCssCode(code){
            var style = document.createElement('style');
            style.type = 'text/css';
            style.rel = 'stylesheet';
            //for Chrome Firefox Opera Safari
            style.appendChild(document.createTextNode(code));
            //for IE
            //style.styleSheet.cssText = code;
            var head = document.getElementsByTagName('head')[0];
            head.appendChild(style);
        }
        

        function label_style_color() {
            // 为标签添加CSS样式
            //$(".self_span").addClass("self_span_bak"); //base style for all labels
            g_lab_len = g_span_labels.length;
            var csscode = "";
            for (k=0; k<g_lab_len; k++) {
                var lab_txt = ".span_label_" + g_span_labels[k];
                var lab_ind = base_labels.indexOf(g_span_labels[k]);
                //console.log(lab_txt);
                //console.log(lab_ind);
                //console.log("==================");
                if (lab_ind >= 0 && lab_ind < label_colors.length) {
                    csscode = csscode + lab_txt + "{background-color:rgb(" + label_colors[lab_ind][0].toString()+","+label_colors[lab_ind][1].toString()+","+label_colors[lab_ind][2].toString() + ")}";
                } else {
                    //generate color randly
                    var c_r = parseInt(Math.random()*(color_max-color_min+1)+color_min);
                    var c_g = parseInt(Math.random()*(color_max-color_min+1)+color_min);
                    var c_b = parseInt(Math.random()*(color_max-color_min+1)+color_min);
                    csscode = csscode + lab_txt + "{background-color:rgb(" + c_r.toString()+","+c_g.toString()+","+c_b.toString() + ")}";
                }
            }
            //console.log(csscode);
            loadCssCode(csscode)
        }

        function custom_sort(sortName,sortOrder,data) {
            data.sort(function(a,b) {
                let aa = new Date(a[sortName]).getTime(); // 非数字替换成空字符串
                let bb = new Date(b[sortName]).getTime();
                if (sortOrder == 'desc') {
                    return aa-bb;
                } else {
                    return bb-aa;
                }
            })
        }


        function initial_table(tableData){
            //console.log(tableData);
            Paper_Num = tableData.length;
            $('#table').bootstrapTable({
                data: tableData,
                toolbar: "#toolbox",
                uniqueId:'id',
                height: 712,
                search: true,
                showColumns: true,
                showRefresh: false,
                showToggle: true,
                showSearchClearButton: true,
                detailView: true,
                detailViewIcon: true,
                detailViewByClick: false,
                sortable: true,
                sortName: "id",
                customSort: custom_sort,

                onClickRow: function (row, ele, field) {
                    //console.log(field);
                    //console.log(row);
                    //console.log(ele.data('index'));
                    row_index = ele.data('index');
                    document.getElementById("uproll_input").value = row_index;
                    bar_h = (row_index + 1) / Paper_Num * 300
                    document.getElementById("pos_bar_ind").style.height = bar_h + 'px';

                },

                detailFormatter: function(index, row, element) {
                    var text = "<button class=\"btn btn-dark note_btn\" onclick=\"show_notemodal(" + index.toString() + ")\"><i class=\"far fa-sticky-note\"></i></button>";

                    text = text + "<div class=\"note_box\" style=\"border-right:2px solid #eee;\">";
                    // markdown to html
                    var nts= row["notes"];
                    nts = nts.split("\n");
                    var mp = parseInt(nts.length/2);
                    var t1 = nts.slice(0,mp);
                    t1 = t1.join("\n");
                    var t2 = nts.slice(mp,nts.length);
                    t2 = t2.join("\n");

                    var converter = new showdown.Converter();
                    // 配置属性
                    converter.setOption('parseImgDimensions', true);
                    converter.setOption('tables', true);
                    converter.setOption('tasklists', true);
                    converter.setOption('emoji', true);
                    //var thisConverterSpecificOptions = converter.getOptions();
                    //console.log(thisConverterSpecificOptions);
                    //console.log("***************");
                    var ht1 = converter.makeHtml(t1);
                    var ht2 = converter.makeHtml(t2);

                    text = text + ht1;
                    text = text + "</div>";

                    text = text + "<div class=\"note_box\">" + ht2 + "</div>";
                    
                    //console.log(text);
                    return text;
                },

                cardView: false,
                sortable: false,
                columns: [{
                    // radio: true, // 单选
                    checkbox: true,
                    width: 40
                }, {
                    field: 'id',
                    title: 'ID',
                }, {
                    field: 'title',
                    title: 'Title',
                }, {
                    field: 'authors',
                    title: 'Authors',
                    width: 130
                }, {
                    field: "year",
                    title: "Dt",
                    width: 50,
                }, {
                    field: "journal",
                    title: "Journal",
                    width: 130
                }, {
                    field: "file",
                    title: "F",
                    width: 40,
                    formatter: function (value, row, index) {
                        //console.log(typeof(value));
                        var val_tmp = "<i class=\"fas fa-times\"></i>";
                        //console.log("****path*****");
                        //console.log(value);
                        var file_name = value.split("/");
                        file_name = file_name[file_name.length-1];
                        if (value != undefined) {
                            if (value.length>0) {
                                val_tmp = "<a href=\"" +
                                value +
                                "\" title=\"" +
                                file_name +
                                "\" target=\"#\">" +
                                "<i class=\"fas fa-link\"></i>" +
                                "</a>";
                            }
                        }
                        //console.log(val_tmp);
                        return val_tmp;
                    }
                }, {
                    field: "cited",
                    title: "ct",
                    width: 40
                }, {
                    field: "rank",
                    title: "Rank",
                    width: 120,
                    formatter: function (value, row, index) {
                        var s = "<i class=\"fas fa-star\"></i>";
                        var res;
                        if (value==0) {
                            res = "";
                        } else if (value==1) {
                            res = s;
                        } else if (value==2) {
                            res = s + s;
                        } else if (value==3) {
                            res = s + s + s;
                        } else if (value==4) {
                            res = s + s + s + s;
                        } else if (value==5) {
                            res = s + s + s + s + s;
                        }
                        res = "<div class=\"rank_star\">" + res + "</div>"
                        return res;
                    }
                }, {
                    field: "tags",
                    title: "Tags",
                    width: 120,
                    formatter: function (value, row, index) {
                        var tgs = new Array();
                        tgs = value.split("|");
                        //console.log(tgs);
                        var res = "";

                        if (tgs[0]!="") {
                            for (i=0; i<tgs.length; i++) {
                                /*// 判断是否添加全局tags_all
                                // 统计全局tags出现的次数
                                if (tags_all.hasOwnProperty(tgs[i])) {
                                    //console.log(tgs[i]);
                                    //console.log('=====111=====');
                                    tags_all[tgs[i]] = tags_all[tgs[i]] + 1;
                                } else {
                                    //console.log(tgs[i]);
                                    //console.log('=====222=====');
                                    tags_all[tgs[i]] = 0;
                                }*/

                                // 根据基本的样式，添加基本标签类
                                var exist_fg = g_span_labels.includes(tgs[i]);
                                exist_fg = !exist_fg;
                                //console.log(exist_fg);
                                if (exist_fg) {
                                    g_span_labels.push(tgs[i]);
                                }

                                res = res + "<span class=\"self_span_bak span_label_" + tgs[i] + "\">" + tgs[i] + "</span>";
                            }
                        }
                        return res;
                    }
                }, {
                    field: "flags",
                    title: "Flags",
                    width: 90,
                    formatter: function (value, row, index) {
                        if (!(value=="")) {
                            var txt = "<div class=\"flag_box\">";
                            var f_val = value.split("|");
                            var flag_num = f_val.length;
                            var idx;
                            var p;
                            var t;
                            if (flag_num>0) {
                                for (i=0; i<flag_num; i++) {
                                    idx = parseInt(f_val[i]);
                                    //console.log(idx);
                                    //console.log("----------->>><<<---------------------");
                                    p = f[idx].getAttribute("data-img-src");
                                    t = f[idx].innerText;
                                    txt = txt + "<img class=\"flag_img\" src=\"" + p + "\" alt=\"" + t + "\"/>";

                                }
                            }
                            txt = txt + "</div>";
                            return txt;
                        } else {
                            return "";
                        }

                    }
                }, {
                    field: "type",
                    title: "Tp",
                    width: 90
                }, {
                    field: 'operator',
                    title: 'Edit',
                    align: 'center',
                    valign: 'middle',
                    width: 100,
                    // visible: false,
                    formatter: function (value, row, index) {
                        // var sid_code = base64encode(row.sid + '');   //  sid 加密处理
                        // alert(sid_code);
                        return '<a title="edit" style="cursor:pointer;">' +
                        		'<i class="fas fa-pencil-alt"></i> ' +
                                '</a>' +
                                '<a title="export" style="cursor:pointer;">' +
                                '<i class="fas fa-cloud-download-alt"></i> ' +
                                '</a>' +
                                '<a title="delete" style="cursor:pointer;">' +
                                '<i class="far fa-trash-alt"></i>' +
                                '</a>';
                    },
                    events: {
                        'click a[title="delete"]': function (e, value, row, index) {
                            if (confirm('Are you sure to delete this item?')) {
                                // 确定删除执行
                                $('#table').bootstrapTable('remove', {field: 'title', values: [row["title"]]});
                                delete_paper(row["id"]);
                            }
                        },
                        'click a[title="edit"]': function (e, value, row, index) {
                            //console.log("===edit data===");
                            //console.log(row);
                            // 重置数据
                            var strbib;
                            if (row["endnote"]=="") {
                            	strbib = "%0 ";
	                            strbib = strbib + row["type"] + "\n";
	                            strbib = strbib + "%T " + row["title"] + "\n";
	                            strbib = strbib + "%A " + row["authors"] + "\n";
	                            strbib = strbib + "%J " + row["journal"] + "\n";
	                            strbib = strbib + "%D " + row["year"] + "\n";
	                            strbib = strbib + "%# " + row["others"];
                            } else {
                            	strbib = row["endnote"];
                            }
	                            

                            // 存储打开的编辑框中的笔记
                            edit_notes = row["notes"];
                            edit_time = row["id"];

                            document.getElementById("BibTextext").value = strbib;
                            document.getElementById("rpath").value = row["file"];
                            document.getElementById("tags").value = row["tags"];
                            document.getElementById("cited").value = row["cited"];
                            $("#rank").val(row["rank"]);
                            //console.log(row_data);

                            add_pos = index;
                            add_flag = "update";
                            if (row["cite_file_type"]==undefined) {
                                cite_file_type = "enw";
                            } else {
                                cite_file_type = row["cite_file_type"];
                            }
                            
                            //重新显示模态框
                            $('#PaperModal').modal('show');
                            
                        },
                        'click a[title="export"]': function (e, value, row, index) {
                        	var endn = row["endnote"];
                        	console.log("endn");
                        	console.log(endn);
                            if (endn=="") {
                            	alert("endnote does not exist!!!");
                            } else {
                                if (row["cite_file_type"]=="") {
                                    downloadFile(endn, "enw", "paperendnote");
                                } else {
                                    downloadFile(endn, row["cite_file_type"], "paperendnote");
                                }
                            }
                        },
                        'click a[title="add"]': function (e, value, row, index) {
                            add_pos = index + 1; //在下方插入
                            //重新显示模态框
                            $('#PaperModal').modal('show');
                        }
                    }
                }, {
                    "field": "others",
                    "title": "Others"
                }, {
                    "field": "notes",
                    "title": "Notes"
                }, {
                    "field": "endnote",
                    "title": "Edn"
                }, {
                    "field": "cite_file_type",
                    "title": "Cite_File_Type"
                }]
            });

            //创建目录
            $("#table").bootstrapTable('hideColumn', ['others','notes','id',"endnote","cite_file_type"]);
            label_style_color(); //添加标签样式的颜色
        }

    </script>


    <script type="text/javascript">
        var request = indexedDB.open("library");
        var db;
        request.onupgradeneeded = function() {
            // The database did not previously exist, so create object stores and indexes.
            var db = request.result;
            var store = db.createObjectStore("papers", {keyPath: "id"});
            var titleIndex = store.createIndex("by_title", "title", {unique: false});
            console.log("----> onupgradeneeded <--------");
            // Populate with initial data.
        };

        request.onsuccess = function() {
          db = request.result;
          console.log('-->sucess to open database<--');
        };

        request.onerror = function (event) {
            console.log('-->fial to open database<--');
        };


        function add_paper(data,descp) {
            var tx = db.transaction(['papers'], 'readwrite').objectStore('papers').add(data);

            tx.onsuccess = function (event) {
                console.log('sucess to add');
                $('#msg').text("msg: sucess to ADD " + descp + " ...");
            };

            tx.onerror = function (event) {
                console.log('fail to add');
                $('#msg').text("msg: sucess to ADD " + descp + " ...");
            }
        }


        function delete_paper(key) {
            var tx = db.transaction(['papers'], 'readwrite').objectStore('papers').delete(key);

            tx.onsuccess = function (event) {
                console.log('sucess to delete');
                $('#msg').text("msg: sucess to DELETE ...");
            };

            tx.onerror = function (event) {
                console.log('fail to delete');
                $('#msg').text("msg: sucess to DELETE ...");
            }
        }


        function update_paper(data,descp) {
            var tx = db.transaction(['papers'], 'readwrite').objectStore('papers').put(data);

            tx.onsuccess = function (event) {
                console.log('sucess to update');
                $('#msg').text("msg: sucess to UPDATE " + descp + " ...");
            };

            tx.onerror = function (event) {
                console.log('fail to update');
                $('#msg').text("msg: sucess to UPDATE " + descp + " ...");
            }
        }

        
        function read_all_paper() {
            var papers_db_all = new Array();
            var tx = db.transaction(['papers'], 'readwrite');
            var store = tx.objectStore('papers');

            var request = store.openCursor();
            request.onsuccess = function(event) {
                var cursor = event.target.result;
                if (cursor) {
                    // Called for each matching record.
                    //console.log(papers_db_all);
                    papers_db_all.push(cursor.value)
                    cursor.continue();
                } else {
                    // No more matching records.
                    console.log('-->No more matching records.<--');
                    initial_table(papers_db_all);
                }
            };
            request.onerror = function (event) {
                console.log("fail to read all");
            }
        }

    </script>

    <script type="text/javascript">
        // 读取json素组
        var docs;
        var base_labels;
        var label_colors;

        function config_setting(data) {
            //console.log(data);
            base_labels = data[0]["labels"];
            docs = data[0]["docs"];
            label_colors = data[0]["colors"];
        }

        function paper(data) {
        }
    </script>

    <!-- 引入要放在后面 -->
    <!-- 需要注意的是:
    <script type="text/javascript" src="./index.json?callback=dataJson"></script>中的
        src中： ? 之前为文件地址，? 之后为回调函数callback名称，
        回调函数可以简写为 cb ,  回调函数名称要与文件中的名称一致，如本文件中的dataJson
        如，index.json?cb=abc，那么 index.json 的名字为 abc-->
    <!--script type="text/javascript" src="./data.json?cb=paper"></script-->
    <script type="text/javascript" src="./config.json?cb=config_setting"></script>


    <!-- 定义好表格，请求数据，再去初始化表格 -->
    <script type="text/javascript">

        var open_interval = setInterval(function(){
            if (db != undefined) {
                read_all_paper(); //加载数据
                clearInterval(open_interval);
            } 
        }, 60);


        //创建目录
        var doc_dom = document.getElementById("docs_items");
        var doc_txt;
        var doc_opt;
        for (cc in docs) {
            doc_txt = docs[cc];
            doc_opt = document.createElement('div');
            doc_opt.innerText = doc_txt;
            doc_opt.setAttribute("class","docs-item");
            doc_opt.setAttribute("onclick","show_docs_items(\"" + doc_txt + "\")");
            doc_dom.appendChild(doc_opt);
        }

    </script>


    <script type="text/javascript">
        function read_cite() {
            var reader = new FileReader();
            reader.onload = function() {
                cite_text = this.result;
                var txt = document.getElementById("BibTextext");
                txt.value = cite_text;
            }
            var f = document.getElementById("cite").files[0];
            var f_name = f.name;
            console.log(f_name);
            if (f_name != undefined) {
                var f_type = f_name.split(".");
                f_type = f_type[f_type.length-1];
                cite_file_type = f_type;
                reader.readAsText(f);
            }
            
            document.getElementById('cite').value = null; //重置cite为空
        }

        function read_file() {
            var p = document.getElementById("rpath").value;
            var pname = document.getElementById('file').files[0].name;
            if (pname != undefined) {
                var path = p + "/" + pname;
                document.getElementById("rpath").value = path;
            }
            document.getElementById('file').value = null; //重置file为空
        }

        function get_data() {
            var txt = document.getElementById("BibTextext").value;
            var dict = {"id":"","type":"", "title":"", "authors":"","rank":-1, "tags":"", "flags":"", "journal":"", "file":"", "year":0, "others":"", "notes":"", "cited":-1, "endnote":"", "cite_file_type":""};
            dict["cite_file_type"] = cite_file_type;
            dict["endnote"] = txt;
            if (txt.length>3){
                if (cite_file_type=="enw") {
                    var strs = txt.split("\n");
                    //console.log(strs);
                    for (i=0; i<strs.length; i++){
                        subtxt = strs[i].trim();
                        len = subtxt.length
                        if (len>3){
                            flag = subtxt[1];
                            val = subtxt.slice(3,len);
                            //console.log(val);
                            if (flag=="0") {
                                dict["type"] = dict["type"] + val;
                            } else if (flag=="T") {
                                dict["title"] = dict["title"] + val;
                            } else if (flag=="A") {
                                if (dict["authors"]==""){
                                    dict["authors"] = dict["authors"] + val;
                                } else {
                                    dict["authors"] = dict["authors"] + "|" + val;
                                }
                            } else if (flag=="B" || flag=="J") {
                                dict["journal"] = dict["journal"] + val;
                            } else if (flag=="D") {
                                dict["year"] = parseInt(val);
                            } else if (flag=="$") {
                                dict["notes"] = dict["notes"] + val;
                            } else if (flag=="#") {
                                dict["others"] = dict["others"] + val;
                            } else {
                                if (dict["others"]==""){
                                    dict["others"] = dict["others"] + flag + ":" + val;
                                } else {
                                    dict["others"] = dict["others"] + "|" + flag + ":" + val;
                                }
                            }
                        }       
                    }
                } else if (cite_file_type=="bib") {
                    var strs = txt.split("\n");
                    for (i=1; i<strs.length; i++){
                        subtxt = strs[i].trim();
                        //console.log(subtxt);
                        len = subtxt.length;
                        if (len>3){
                            subtxt = subtxt.split("=");
                            flag = subtxt[0].trim();
                            val = subtxt[1].split("\"")[1];
                            //console.log(flag);
                            //console.log(val);
                            if (flag=="title") {
                                dict["title"] = dict["title"] + val;
                            } else if (flag=="journal") {
                                dict["journal"] = dict["journal"] + val;
                                dict["type"] = dict["type"] + "journal";
                            } else if (flag=="year") {
                                dict["year"] = parseInt(val);
                            } else if (flag=="author") {
                                dict["authors"] = dict["authors"] + val.replace(/ and /g,"|");
                            } else {
                                if (dict["others"]==""){
                                    dict["others"] = dict["others"] + flag + ":" + val;
                                } else {
                                    dict["others"] = dict["others"] + "|" + flag + ":" + val;
                                }
                            }

                        }
                    }
                } else if (cite_file_type=="ris") {
                    var strs = txt.split("\n");
                    //console.log("----------------");
                    for (i=0; i<strs.length; i++){
                        subtxt = strs[i].trim();
                        console.log(subtxt);
                        len = subtxt.length;
                        if (len>6){
                            subtxt = subtxt.split("  - ");
                            flag = subtxt[0].trim();
                            val = subtxt[1].trim();
                            //console.log(flag);
                            //console.log(val);
                            if (flag=="TI" || flag=="T1") {
                                dict["title"] = dict["title"] + val;
                            } else if (flag=="JO" || flag=="JF") {
                                dict["journal"] = dict["journal"] + val;
                            } else if (flag=="TY") {
                                if (val=="JOUR") {
                                    dict["type"] = dict["type"] + "journal";
                                } else {
                                    dict["type"] = dict["type"] + val;
                                }
                            } else if (flag=="PY") {
                                dict["year"] = parseInt(val);
                            } else if (flag=="AU") {
                                if (dict["authors"]==""){
                                    dict["authors"] = dict["authors"] + val;
                                } else {
                                    dict["authors"] = dict["authors"] + "|" + val;
                                }
                            } else {
                                if (dict["others"]==""){
                                    dict["others"] = dict["others"] + flag + ":" + val;
                                } else {
                                    dict["others"] = dict["others"] + "|" + flag + ":" + val;
                                }
                            }
                        }
                    }
                }
            }

            var r = $("#rank option:selected").val();
            var tags = document.getElementById("tags").value;
            var cited = document.getElementById("cited").value;

            var flag_ind = new Array();
            var flags_li = $("li.search-choice");
            for (i=0; i<flags_li.length; i++){
                var la = flags_li[i].getElementsByTagName("a")[0];
                var ind = la.getAttribute("data-option-array-index");
                flag_ind.push(ind);
            }
            flag_ind = flag_ind.join("|");

            dict["rank"] = parseInt(r);
            dict["tags"] = tags;
            dict["flags"] = flag_ind;
            dict["file"] = document.getElementById("rpath").value;
            dict["cited"] = parseInt(cited);
            dict["id"] = get_time();
            return dict;
        }

        function clear_modal() {
            // 重置数据
            document.getElementById("BibTextext").value = "";
            document.getElementById("rpath").value = "../pdf/";
            document.getElementById("tags").value = "";
            document.getElementById("cited").value = "";
            $("#rank").val("0");
            //修改一些状态变量
            add_pos = 0;
            add_flag = "insert";
            edit_notes = ""; //重新置为空
            edit_time = "";
            cite_file_type = null;
        }
            

        function close_modal() {
        	$('#PaperModal').modal('hide'); //关闭模态框
        	// 清除模态框的数据
        	clear_modal();
        }

        function add_items () {
        	console.log(add_pos);
        	var data = get_data();

        	if (add_flag=="insert") {
        		// 添加数据
	        	if (data["title"].length>0) {
	        		$("#table").bootstrapTable('insertRow', {index:add_pos, row:data});
                    add_paper(data,'paper ' + data["title"].slice(0,10));
	        		add_pos = 0; // 重新改变默认插入位置
	        		add_flag = "insert";
                    
	        	};
        	} else if (add_flag=="update") {
        		// 更新数据
        		if (data["title"].length>0) {
                    //更新数据，保持笔记和添加时间（id）不改变
                    data["notes"] = edit_notes;
                    data["id"] = edit_time;
	        		$("#table").bootstrapTable('updateRow', {index:add_pos, row:data});
                    update_paper(data,'paper' + data["title"].slice(0,10));
	        		add_pos = 0; // 重新改变默认插入位置
	        		add_flag = "insert";
	        	};

        	}
        	$('#PaperModal').modal('hide'); //关闭模态框
        	// 清除模态框的数据
        	clear_modal();

        }

        function show_notemodal(num) {
        	note_ind = parseInt(num);
        	//console.log(note_ind);
        	//console.log(typeof(note_ind));
        	$("#table").bootstrapTable('check', num);
        	var row_data = $("#table").bootstrapTable('getSelections')[0];
        	now_note = row_data["notes"];
        	note_id = row_data["id"];
        	//console.log(now_note);
        	document.getElementById("notearea").value = now_note;
        	$('#notemodal').modal('show');
        }

        function close_notemodal () {
        	$('#notemodal').modal('hide');
        	$("#table").bootstrapTable('uncheck', note_ind);
        	note_ind = null;
        	note_id = null;
        }

        function update_notes () {
        	var n = document.getElementById("notearea").value;
        	if (n.length>0 && note_ind!=null) {
        		$("#table").bootstrapTable('updateCell', {index: note_ind, field: 'notes', value: n});
                var note_row_data = $("#table").bootstrapTable('getRowByUniqueId', note_id);
                note_row_data["notes"] = n;
                update_paper(note_row_data,'notes ' + note_row_data["title"].slice(0,10));
        	}
        	$('#notemodal').modal('hide');
        	$("#table").bootstrapTable('uncheck', note_ind);
        	note_ind = null;
        	note_id = null;
        	document.getElementById("notearea").value = "";
        }

        function show_docs() {
        	$('#table').bootstrapTable('filterBy', {},
        	{
        		'filterAlgorithm': function(row,filters) {
        			return true;
        		}
        	});
        }

        // 过滤 分组显示
        function show_docs_items(itm) {
        	var f = "../pdf/" + itm;
        	$('#table').bootstrapTable('filterBy', {file: f},
        	{
        		'filterAlgorithm': function(row,filters) {
        			//console.log(row["file"]);
        			var ff = row["file"];
        			var ffs = ff.split("/");
        			ffs.pop();
        			var lab = ffs.join("/");
        			//console.log(lab);
        			if(lab==filters.file) {
        				return true;
        			} else {
        				return false;
        			}
        		}
        	});
        }

        //控制面板
        function set_panel() {
            $('#panel').removeClass("panel_hide"); //关闭模态框
            $('#panel').addClass("panel_show"); //关闭模态框
        }

        function close_panel() {
            $('#panel').removeClass("panel_show"); //关闭模态框
            $('#panel').addClass("panel_hide"); //关闭模态框
            document.getElementById("panel").style.top = "60px";
            document.getElementById("panel").style.left="0.5%";

        }

        function set_color () {
            var bg_color = $("#bg").val();
            bg_color = bg_color.split(" ");
            bg_color = bg_color.join(",");
            
            $("html").css("background-color","rgb(" + bg_color + ")");
            $("body").css("background-color","rgb(" + bg_color + ")");
        }


        var search_his = "";
        var search_stack = new Array();
        var search_stack_ind = 0;
        function search_txt() {
            console.log("====search====");
            var st = document.getElementById('search_area').value;
            if (st.length>0) {
                if (st==search_his) {
                    if (search_stack[search_stack_ind]>=0) {
                        $('#table').bootstrapTable('scrollTo',{unit: 'rows', value: parseInt(search_stack[search_stack_ind])});
                    }
                    search_stack_ind = (search_stack_ind+1)%(search_stack.length);

                } else {
                    var tdp = table_data_pre("search");
                    search_his = st;
                    st = st.split(">");
                    var search_key = "";
                    if (st[0]=="title") {
                        search_key = "title";
                    } else if (st[0]=="author"){
                        search_key = "authors";
                    } else if (st[0]=="note"){
                        search_key = "notes";
                    }
                    //console.log(search_key);
                    if (search_key!="") {
                        search_stack = []; // 新的搜索，置空列表
                        search_stack_ind = 0;
                        search_data = tdp[search_key];
                        var str_tar = "";
                        var str_field = "";
                        var patt = "";
                        //console.log(search_data);
                        //console.log(str_tar);

                        //console.log("====================");
                        for (var r=0;r<search_data.length;r++) {
                            str_tar = st[1];
                            str_field = search_data[r];
                            patt = new RegExp(str_tar, 'i');
                            if (str_field.search(patt)>=0) {
                                search_stack.push(r);
                            }
                        }
                        // 滚动到第一个
                        $('#table').bootstrapTable('scrollTo',{unit: 'rows', value: parseInt(search_stack[search_stack_ind])});
                        search_stack_ind = (search_stack_ind+1)%(search_stack.length);

                    }
                }
            }
        }


    </script>
    
    <script type="text/javascript">
        function save_data() {
            //console.log("s_data");
            var s_data= $('#table').bootstrapTable('getData', {useCurrentPage: false, includeHiddenRows: true});
            //console.log(s_data);
            //console.save(s_data,'data_bak.json');
            downloadFile(s_data, "json", "paperjson")
        }


        function delete_rows() {
    		var st = $('#table').bootstrapTable('getAllSelections');
        	//console.log(st);
        	if (st.length>0){
        		if (confirm('Are you sure to delete this item?')) {
	        		var ind = new Array();
		        	for (k in st)
		        	{
		        		if (st[k]["title"].length>0){
		        			//console.log(st[k]["title"]);
		        			ind.push(st[k]["title"]);
		        		}
		        	}

		        	$('#table').bootstrapTable('remove', {field: 'title', values: ind});
		        }
        	}
        }

        function get_time() {
            var date = new Date();
            
            var year = date.getFullYear();        //年 ,从 Date 对象以四位数字返回年份
            var month = date.getMonth() + 1;      //月 ,从 Date 对象返回月份 (0 ~ 11) ,date.getMonth()比实际月份少 1 个月
            var day = date.getDate();             //日 ,从 Date 对象返回一个月中的某一天 (1 ~ 31)
            
            var hours = date.getHours();          //小时 ,返回 Date 对象的小时 (0 ~ 23)
            var minutes = date.getMinutes();      //分钟 ,返回 Date 对象的分钟 (0 ~ 59)
            var seconds = date.getSeconds();      //秒 ,返回 Date 对象的秒数 (0 ~ 59)   
            
            //获取当前系统时间  
            var currentDate = year + "-" + month + "-" + day + " " + hours + ":" + minutes + ":" + seconds;
            
            /*修改月份格式
            if (month >= 1 && month <= 9) {
                month = "0" + month;
                }
            
            //修改日期格式
            if (day >= 0 && day <= 9) {
                day = "0" + day;
                }
            
            //修改小时格式
            if (hours >= 0 && hours <= 9) {
                hours = "0" + hours;
                }
            
            //修改分钟格式
            if (minutes >= 0 && minutes <= 9) {
                minutes = "0" + minutes;
                }
            
            //修改秒格式
            if (seconds >= 0 && seconds <= 9) {
                seconds = "0" + seconds;
                }
            
            //获取当前系统时间  格式(yyyy-mm-dd hh:mm:ss)
            var currentFormatDate = year + "-" + month + "-" + day + " " + hours + ":" + minutes + ":" + seconds;*/

            return currentDate;
        }
    </script>
     

     <script type="text/javascript">
        //小鸟图片
        var image;
        function mask_img(data) {
            //console.log(data);
            image = data[0];
        }
        //console.log(image);
     </script>
     <script type="text/javascript" src="./mask_image.json?cb=mask_img"></script>


     <script type="text/javascript">
     	function table_data_pre (feild) {
     		var tdp = new Array();
     		var t_data = $('#table').bootstrapTable('getData', {useCurrentPage: false, includeHiddenRows: true});
            var jrl = new Array();
            var tags_all = new Array();
            var title = new Array();
            var authors = new Array();
            var notes = new Array();


            if (feild=="charts") {

                for (i=0; i<t_data.length;i++) {
                    //标题
                    //title.push(t_data[i]['title']);
                    //作者
                    //authors.push(t_data[i]['authors']);
                    //期刊
                    if (jrl.hasOwnProperty(t_data[i]['journal'])) {
                        jrl[t_data[i]['journal']] += 1;
                    } else {
                        jrl[t_data[i]['journal']] = 1;
                    }
                    //标签
                    var tg_i = t_data[i]['tags'];
                    var tg_array = tg_i.split("|");
                    for (j in tg_array) {
                        if (tg_array[j] != "") {
                            if (tags_all.hasOwnProperty(tg_array[j])) {
                                tags_all[tg_array[j]] += 1;
                            } else {
                                tags_all[tg_array[j]] = 1;
                            }
                        }
                    }
                    //笔记
                    //notes.push(t_data[i]['notes']);
                }

            } else if (feild=="search") {

                for (i=0; i<t_data.length;i++) {
                    //标题
                    title.push(t_data[i]['title']);
                    //作者
                    authors.push(t_data[i]['authors']);
                    //笔记
                    notes.push(t_data[i]['notes']);

                }

            }

                
            tdp["jrl"] = jrl;
            tdp["tags_all"] = tags_all;
            tdp["title"] = title;
            tdp["authors"] = authors;
            tdp["notes"] = notes;

            return tdp
     	}
        
     </script>
    


    <!-- 绘图 -->
    <script type="text/javascript">
        function draw_c1 (jrl) {
            var c1x = new Array();
            var c1y = new Array();

            for(var key in jrl){
                c1x.push(key);
                c1y.push(jrl[key]);
                //console.log(key + "-->" + jrl[key]);
            }
            //console.log(c1x);
            //console.log(c1y);

            var mmax = Math.max.apply(null,c1y);
            var mmin = Math.min.apply(null,c1y)


            // 指定图表的配置项和数据
            var option1 = {
                title: {
                    text: 'journals'
                },
                tooltip: {},
                legend: {
                    data:['journals']
                },
                xAxis: [{
                    type: 'category',
                    data: c1x,
                    axisTick: {
                        alignWithLabel: true
                    },
                    axisLabel: {  /*****重点还是在这里哦**///
                        textStyle: {
                            color: '#7c8893',
                            fontSize: 12
                        },
                        interval: 0,
                        rotate: 15,
                        formatter: function(params) {
                            //console.log(params);
                            if (params.length>20) {
                                return params.slice(0,20) + "..."
                            }
                            return params;
                        }
                    },
                    splitLine: {
                        show: true,
                        lineStyle: {
                            type: 'dashed'
                        }
                    },
                    triggerEvent: true,
                    axisLine: {
                        show: true,
                        interval: 0,
                        lineStyle: {
                            color: "RGB(210,221,217)"
                        }
                    }
                }],
                yAxis: {},
                series: [{
                    name: 'journals',
                    type: 'bar',
                    itemStyle: {
                        normal: {
            　　　　　　　　//这里是重点
                            color: function(params) {
                                //console.log(params);
                                //console.log("******************");
                                //注意，如果颜色太少的话，后面颜色不会自动循环，最好多定义几个颜色
                                var ind = (params.data - mmin) / (mmax-mmin);
                                ind = parseInt(ind*15);
                                var colorList = ['#fee','#fdd', '#fcc', '#fbb', '#faa','#f99', '#f88', '#f77', '#f66', '#f55', '#f44', '#f33', '#f22', '#f11', '#f00'];
                                return colorList[ind];
                            }
                        }
                    },
                    data: c1y
                }]
            };

            var c1 = echarts.init(document.getElementById('chart1'));
     
            // 使用刚指定的配置项和数据显示图表。
            c1.setOption(option1);

        }

        function draw_c2(tags_all) {
            // chart 2
            var c2_data = new Array();

            for(var key in tags_all){
                //console.log({"name":key,"value":tags_all[key]});
                c2_data.push({"name":key,"value":tags_all[key]});
                //console.log(key + "-->" + tags_all[key]);
            }

            //console.log(c2_data);
            var maskImage = new Image();
            maskImage.src = image;

            var option2 = {
                backgroundColor:'#fff',
                tooltip: {
                    show: true
                },
                series: [{
                    name: 'Tags',
                    type: 'wordCloud',
                    sizeRange: [10, 50],//文字范围
                    //文本旋转范围，文本将通过rotationStep45在[-90,90]范围内随机旋转
                    rotationRange: [-45, 90],
                    rotationStep: 45,
                    textRotation: [0, 45, 90, -45],
                    maskImage: maskImage,
                    //形状
                    //shape: 'circle',
                    textStyle: {
                        normal: {
                            color: function() {//文字颜色的随机色
                                return 'rgb(' + [
                                    Math.round(Math.random() * 250),
                                    Math.round(Math.random() * 250),
                                    Math.round(Math.random() * 250)
                                ].join(',') + ')';
                            }
                        },
                        //悬停上去的颜色设置
                        emphasis: {
                            shadowBlur: 10,
                            shadowColor: '#333'
                        }
                    },
                    data: c2_data
                }]
            };
            //使用制定的配置项和数据显示图表
            var c2 = echarts.init(document.getElementById('chart2'));
            c2.setOption(option2);

        }

        draw_c2();

    	function show_charts() {
            // 表格统计数据
            var tdp = table_data_pre("charts");
            $('#charts_modal').removeClass("charts_hide"); //关闭模态框
            $('#charts_modal').addClass("charts_show"); //base style for all labels; //显示模态框
            draw_c1(tdp["jrl"]);
            draw_c2(tdp["tags_all"]);

            
        }

    	function close_chartsmodal() {
            $('#charts_modal').removeClass("charts_show"); //关闭模态框
    		$('#charts_modal').addClass("charts_hide"); //关闭模态框
    	}

    	function save_chartsmodal() {
            $('#charts_modal').removeClass("charts_show"); //关闭模态框
    		$('#charts_modal').addClass("charts_hide"); //关闭模态框
    	}

        function up2roll() {
            var roll_id = document.getElementById("uproll_input").value;
            if (roll_id=="") {
                 $('#table').bootstrapTable('scrollTo',{unit: 'rows', value: 0});
                 document.getElementById("uproll_input").value = "1";
                 bar_h = 1 / Paper_Num * 300;
                 document.getElementById("pos_bar_ind").style.height = bar_h + 'px';
            } else {
                //alert(parseInt(roll_id));
                $('#table').bootstrapTable('scrollTo',{unit: 'rows', value: parseInt(roll_id)});
                document.getElementById("uproll_input").value = parseInt(roll_id);
                bar_h = parseInt(roll_id) / Paper_Num * 300;
                document.getElementById("pos_bar_ind").style.height = bar_h + 'px';
            }
        }
    </script>

    <script>

    	function import_papers_json() {
            var ele_f = document.createElement("input");
            // 隐藏a标签
            ele_f.type = 'file';
            ele_f.id = 'import_data_json_id';
            ele_f.setAttribute("onchange","read_papers_json()");
            ele_f.style.display = 'none';

            // Dom文档Body里生成一个a标签
            document.body.appendChild(ele_f);
              
            // 模拟点击a标签
            ele_f.click();
        }

        function read_papers_json() {
            //console.log("00000000000000000000000000000000000000000");
            var reader = new FileReader();
            reader.onload = function() {
                var paper_json_str = this.result;
                console.log("222222222222222222222222222222222");
                import_json = JSON.parse(paper_json_str);
                import_json = import_json['paper'];
                $('#msg').text("msg: sucess to load paper data");
                //console.log("删除标签");
                var creat_input = document.getElementById("import_data_json_id");
                document.body.removeChild(creat_input);
            }
            var f = document.getElementById("import_data_json_id").files[0];
            reader.readAsText(f);
            //console.log("11111111111111111111111111111111111111111111111111111111");
        }

        function To_DB() {

            for (k in import_json) {
                db.transaction(['papers'], 'readwrite').objectStore('papers').put(import_json[k]);
            }

            alert("Sucess to import papers to indexedDB!")

            /*var ind = db.transaction(['papers'], 'readonly').objectStore('papers').index('by_title');
            
            ind.onsuccess = function(event) {
                console.log('sucess to open key');
                $('#msg').text("msg: Sucess to open key");

                for (k in import_json) {
                    title = import_json[k]['title'];
                    let request = this.get(title);
                }
                
            }

            ind.onerror = function (event) {
                console.log('fail to open key');
                $('#msg').text("msg: Fail to open key");
            }*/

        }


        //添加保存json素组的方法
        (function(console){
            console.save = function(data, filename){
            if(!data) {
                console.error('Console.save: No data')
                return;
            }
            if(!filename) filename = 'console.json'
                if(typeof data === "object"){
                    data = JSON.stringify(data, undefined, 4)
                }
                var blob = new Blob([data], {type: 'text/json'}),
                e = document.createEvent('MouseEvents'),
                a = document.createElement('a')
                a.download = filename
                a.href = window.URL.createObjectURL(blob)
                a.dataset.downloadurl = ['text/json', a.download, a.href].join(':')
                e.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null)
                a.dispatchEvent(e)
            }
        })(console);

        // 生成指定后缀文件函数
        function downloadFile(data, name, datause) {
        	// data: 要保存的数据; name: 文件后缀名
            // 创建一个a标签
            var ele_a = document.createElement("a");
            // 隐藏a标签
            ele_a.style.display = 'none';
             
            // 定义生成文件的文件名及后缀名
            var fileName = "data." + name;
            ele_a.download = fileName;
            
            var blob = "";
            if (datause=="paperjson") {
            	// 生成一个blob二进制数据，内容为json数据
            	blob = new Blob(["{\"paper\":" + JSON.stringify(data) + "}"]);
            } else if (datause=="paperendnote") {
            	blob = new Blob([data]);
            }
            
            
            // 生成一个指向blob的URL地址，并赋值给a标签的href属性
            ele_a.href = URL.createObjectURL(blob);
              
            // Dom文档Body里生成一个a标签
            document.body.appendChild(ele_a);
            
            // 模拟点击a标签
            ele_a.click();
              
            // 移去a标签
            document.body.removeChild(ele_a);
        }

    </script>

</body>

</html>